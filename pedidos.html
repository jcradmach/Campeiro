<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Expressão do Gaudério</title>
    <link rel="icon" type="image/png" href="favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/style3.css" rel="stylesheet">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

    <div class="mainscreen">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
        <!-- Mobile: Primeira linha - Logo + Carrinho + Toggle -->
        <div class="d-flex w-100 justify-content-between align-items-center d-lg-none">
            <!-- Logo -->
            <a class="navbar-brand d-flex align-items-center" href="catalogo.html">
                <img src="Imagens/logo.png" alt="logo" class="logo-header me-2">
                <span>Expressão do Gaudério</span>
            </a>
            
            <!-- Carrinho + Toggle -->
            <div class="d-flex align-items-center">
                <a href="carrinho.html" class="btn btn-link text-white position-relative px-2 me-2">
                    <i class="fas fa-shopping-cart fs-5"></i>
                    <span id="carrinho-contador" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge">
                        0
                    </span>
                </a>
                
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Desktop: Logo (esquerda) -->
        <a class="navbar-brand d-none d-lg-flex align-items-center" href="index.html">
            <img src="Imagens/logo.png" alt="logo" class="logo-header me-2">
            <span>Expressão do Gaudério</span>
        </a>
        
        <!-- Desktop: Carrinho + User Info (direita) -->
        <div class="d-none d-lg-flex align-items-center ms-auto">
            <!-- Carrinho -->
            <a href="carrinho.html" class="btn btn-link text-white position-relative px-3 me-3">
                <i class="fas fa-shopping-cart fs-5"></i>
                <span id="carrinho-contador-desktop" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge">
                    0
                </span>
            </a>
            
            <!-- User Info -->
            <div class="d-flex align-items-center user-section">
                <i class="fas fa-user-circle me-2"></i>
                <span class="text-white me-3">Olá, <span id="user-name">usuário</span></span>
                
                <div class="d-none" id="user-info">
                    <button class="btn btn-sm btn-outline-light" id="logout-btn">
                        <i class="fas fa-sign-out-alt me-1"></i>Sair
                    </button>
                </div>
                
                <div class="auth-buttons" id="auth-buttons">
                    <a href="cadastro.html" class="btn btn-sm btn-outline-light me-2">
                        <i class="fas fa-user-plus me-1"></i>Cadastre-se
                    </a>
                    <a href="login.html" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-sign-in-alt me-1"></i>Entrar
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Menu Collapse -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- Mobile: Segunda linha - User Info -->
            <div class="d-lg-none">
                <div class="d-flex justify-content-between align-items-center user-section">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle me-2"></i>
                        <span class="text-white">Olá, <span id="user-namem">usuário</span></span>
                    </div>
                    
                    <div class="d-none" id="user-infom">
                        <button class="btn btn-sm btn-outline-light" id="logout-btnm">
                            <i class="fas fa-sign-out-alt me-1"></i>Sair
                        </button>
                    </div>
                    
                    <div class="auth-buttons" id="auth-buttonsm">
                        <a href="cadastro.html" class="btn btn-sm btn-outline-light me-2">
                            <i class="fas fa-user-plus me-1"></i>Cadastre-se
                        </a>
                        <a href="login.html" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-sign-in-alt me-1"></i>Entrar
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Menu Items -->
            <ul class="navbar-nav">
                <!-- Seção Admin -->
                <div id="adminicons" class="admin-section">
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="menu.html">
                        <i class="fas fa-tasks me-2"></i>
                        Painel Admin
                    </a>
                </li>
            </div>
                
                <!-- Seção User -->
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="pedidos.html">
                        <i class="fas fa-shopping-bag me-2"></i>
                        Meus Pedidos
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="meusdados.html">
                        <i class="fas fa-user-edit me-2"></i>
                        Minha Conta
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="ajuda.html">
                        <i class="fas fa-life-ring me-2"></i>
                        Ajuda
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>
        <div class="page-container">
            <div class="container mt-4">
            <h2 class="text-center">Meus Pedidos</h2>
            <div id="lista-pedidos" class="mt-3">
                <div class="d-flex flex-column align-items-center justify-content-center py-5">
                    <!-- Spinner do Bootstrap com cores personalizadas -->
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; border-width: 0.25rem;" role="status">
                    </div>
                    
                </diV>
            </div>
            </div>
        </div>

    </div>

    <!-- Modal Detalhes do Pedido -->
    <div class="modal fade" id="pedidoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ID do Pedido:</strong> <span id="pedidoId"></span></p>
                    <p><strong>Data:</strong> <span id="pedidoData"></span></p>
                    <p><strong>Status:</strong> <span id="pedidoStatus"></span></p>
                    <h5>Itens:</h5>
                    <ul id="pedidoItens"></ul>
                    <h5>Entrega:</h5>
                    <ul id="taxaEntrega"></ul>
                    <button id="gerarQrCode" class="btn btn-success">Gerar QR Code</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pixModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Pagamento via PIX</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <p>Pedido: <span id="pedidoId"></span></p>
              <p>Valor: <span id="pixValor"></span></p>
              <div id="qrCodeContainer" class="my-3">
                <img id="qr-code" style="display: none; width: 250px; height: 250px;" alt="QR Code de pagamento">
              </div>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Escaneie o QR Code ou copie o código PIX
              </div>
              <div class="d-grid gap-2">
              <button id="copyPixBtn" class="btn btn-outline-primary">
                  <i class="fas fa-copy me-2"></i>Copiar Código PIX
              </button>
          </div>
            </div>
          </div>
        </div>
      </div>

      <script type="module" src="src/main.js"></script>
      <script type="module" src="src/auth.js"></script>
      <script type="module" src="src/database.js"></script>
      <script type="module" src="src/carrinho.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>


  
    <script type="module">
        import { auth, database, ref, get } from "./src/main.js";
    
        async function carregarPedidos() {
            await new Promise(resolve => setTimeout(resolve, 2000));
            const user = auth.currentUser;
            if (!user) {
        document.getElementById("lista-pedidos").innerHTML = `
            <div class="text-center space-y-2">
                <p>Você precisa estar logado para ver seus pedidos. </p>
                <a href="login.html" class="inline-block px-4 py-2 bg-pink-500 text-blue rounded-lg hover:bg-pink-600 transition">
                    Faça seu login
                </a>
            </div>
        `;
        return;
    }
    
            const pedidosRef = ref(database, "pedidos");
            const snapshot = await get(pedidosRef);
    
            if (!snapshot.exists()) {
                document.getElementById("lista-pedidos").innerHTML = "<p class='text-center'>Nenhum pedido encontrado.</p>";
                return;
            }
    
            const pedidos = snapshot.val();
            let html = "";
            let encontrou = false;
    
            Object.keys(pedidos).forEach(pedidoId => {
                const pedido = pedidos[pedidoId];
    
                if (pedido.userId === user.uid) {
                    encontrou = true;
                    const dataFormatada = new Date(pedido.dataCria).toLocaleString("pt-BR");
    
                    html += `
                        <div class='card mb-3'>
                            <div class='card-body'>
                                <h5 class='card-title'>Pedido: ${pedidoId}</h5>
                                <p><strong>Data:</strong> ${dataFormatada}</p>
                                <p><strong>Status:</strong> ${pedido.status}</p>
                                <button class='btn btn-primary' onclick='abrirModal("${pedidoId}")'>Ver Detalhes</button>
                            </div>
                        </div>
                    `;
                }
            });
    
            document.getElementById("lista-pedidos").innerHTML = encontrou ? html : "<p class='text-center'>Nenhum pedido encontrado.</p>";
        }
    
        window.abrirModal = (pedidoId) => {
            const user = auth.currentUser;
            if (!user) return;
    
            const pedidoRef = ref(database, `pedidos/${pedidoId}`);
            get(pedidoRef).then(snapshot => {
                if (!snapshot.exists()) return;
    
                const pedido = snapshot.val();
                const dataFormatada = new Date(pedido.dataCria).toLocaleString("pt-BR");
    
                document.getElementById("pedidoId").textContent = pedidoId;
                document.getElementById("pedidoData").textContent = dataFormatada;
                document.getElementById("pedidoStatus").textContent = pedido.status;
                document.getElementById("taxaEntrega").textContent = `R$ ${pedido.taxaEntrega.toFixed(2)}`;
    
                let itensHtml = "";
                pedido.itens.forEach(item => {
                    itensHtml += `<li>${item.nome} - R$ ${item.preco.toFixed(2)} x ${item.quantidade}</li>`;
                });
                document.getElementById("pedidoItens").innerHTML = itensHtml;
    
                new bootstrap.Modal(document.getElementById("pedidoModal")).show();
            });
        };
    
        auth.onAuthStateChanged(user => {
            if (user) carregarPedidos();
        });

        document.getElementById("gerarQrCode").addEventListener("click", async function () {
    const pedidoId = document.getElementById("pedidoId").textContent;
    const user = auth.currentUser;

    if (!user) {
        alert("Você precisa estar logado para gerar o QR Code.");
        return;
    }

    try {
        // Buscar os detalhes do pedido no Firebase
        const pedidoRef = ref(database, `pedidos/${pedidoId}`);
        const snapshot = await get(pedidoRef);

        if (!snapshot.exists()) {
            alert("Pedido não encontrado.");
            return;
        }

        const pedido = snapshot.val();

        if (!pedido.qrCode) {
            alert("QR Code ainda não foi gerado para este pedido.");
            return;
        }

        // Atualizar modal de pagamento com os dados do pedido
        document.getElementById("pixValor").textContent = `R$ ${pedido.total.toFixed(2)}`;
        
        // Limpar QR Code anterior, se houver
        document.getElementById("qrCodeContainer").innerHTML = "";

        // Gerar QR Code na tela
        new QRCode(document.getElementById("qrCodeContainer"), {
            text: pedido.qrCode,
            width: 250,
            height: 250
        });

        // Abrir o modal de pagamento PIX
        const pixModal = new bootstrap.Modal(document.getElementById("pixModal"));
        pixModal.show();

            // Configura o botão de copiar
    document.getElementById('copyPixBtn').onclick = () => {
        navigator.clipboard.writeText(qrCode).then(() => {
            const copyBtn = document.getElementById('copyPixBtn');
            copyBtn.innerHTML = '<i class="fas fa-check me-2"></i>Código copiado!';
            copyBtn.classList.remove('btn-outline-primary');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy me-2"></i>Copiar Código PIX';
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-primary');
            }, 2000);
        });
    };

    } catch (error) {
        console.error("Erro ao buscar QR Code:", error);
        alert("Erro ao recuperar o QR Code do pedido.");
    }
});


// Adiciona eventos aos botões de tamanho e cobertura
document.addEventListener('DOMContentLoaded', () => {
    
    carregarPedidos();
});

    </script>
    
</body>
</html>

